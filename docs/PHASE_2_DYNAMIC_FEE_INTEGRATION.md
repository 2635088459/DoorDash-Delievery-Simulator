# Phase 2 åŠ¨æ€é…é€è´¹é›†æˆæµ‹è¯•æŒ‡å—

## ğŸ¯ å·²å®ŒæˆåŠŸèƒ½

### 1. âœ… åŠ¨æ€é…é€è´¹è®¡ç®—é›†æˆåˆ°è®¢å•åˆ›å»ºæµç¨‹

**æ ¸å¿ƒå˜æ›´:**

1. **Order å®ä½“å¢å¼º** (æ–°å¢ 4 ä¸ªå­—æ®µ)
   - `deliveryDistanceKm`: é…é€è·ç¦»ï¼ˆå…¬é‡Œï¼‰
   - `weatherCondition`: å¤©æ°”çŠ¶å†µæè¿°
   - `badWeatherSurcharge`: æ˜¯å¦å› æ¶åŠ£å¤©æ°”åŠ ä»·
   - `peakHourSurcharge`: æ˜¯å¦åœ¨é«˜å³°æœŸä¸‹å•

2. **OrderService é›†æˆåŠ¨æ€å®šä»·**
   - æ³¨å…¥ `DeliveryFeeCalculator`ã€`DriverService`ã€`WeatherService`
   - è‡ªåŠ¨è®¡ç®—é¤å…åˆ°é…é€åœ°å€çš„è·ç¦»
   - æ ¹æ®ä¸‹å•æ—¶é—´åˆ¤æ–­æ˜¯å¦é«˜å³°æœŸ
   - æ ¹æ®é…é€ä½ç½®æ£€æŸ¥å¤©æ°”çŠ¶å†µ
   - åŠ¨æ€è®¡ç®—é…é€è´¹ï¼ˆæ›¿ä»£å›ºå®šè´¹ç”¨ï¼‰
   - åŠ¨æ€ä¼°ç®—é…é€æ—¶é—´

3. **WeatherService æ¨¡æ‹ŸæœåŠ¡**
   - å½“å‰ï¼š15% æ¦‚ç‡æ¨¡æ‹Ÿæ¶åŠ£å¤©æ°”
   - æœªæ¥ï¼šå¯é›†æˆ OpenWeatherMap API

4. **OrderDTO å¢å¼º**
   - è¿”å›é…é€è·ç¦»ä¿¡æ¯
   - è¿”å›å¤©æ°”çŠ¶å†µ
   - æ˜¾ç¤ºæ˜¯å¦æœ‰åŠ ä»·é¡¹

---

## ğŸ“Š åŠ¨æ€é…é€è´¹è®¡ç®—é€»è¾‘

### è®¡ç®—å…¬å¼

```
åŸºç¡€é…é€è´¹ = $3.00 + (è·ç¦» Ã— $1.50/km)

å¦‚æœæ˜¯é«˜å³°æœŸï¼ˆ11:00-13:00 æˆ– 17:00-20:00ï¼‰:
    é…é€è´¹ = åŸºç¡€é…é€è´¹ Ã— 1.5

å¦‚æœæ˜¯æ¶åŠ£å¤©æ°”:
    é…é€è´¹ = é…é€è´¹ Ã— 1.2

æœ€ä½é…é€è´¹ = $2.00
```

### ç¤ºä¾‹è®¡ç®—

#### åœºæ™¯ 1: æ™®é€šè®¢å•ï¼ˆ3kmï¼Œä¸‹åˆ3ç‚¹ï¼Œå¤©æ°”æ­£å¸¸ï¼‰

```
åŸºç¡€è´¹ç”¨: $3.00
è·ç¦»è´¹ç”¨: 3km Ã— $1.50/km = $4.50
å°è®¡: $3.00 + $4.50 = $7.50
é«˜å³°æœŸåŠ ä»·: å¦
æ¶åŠ£å¤©æ°”åŠ ä»·: å¦
-------------------------------
æœ€ç»ˆé…é€è´¹: $7.50
é¢„è®¡é…é€æ—¶é—´: 10åˆ†é’Ÿï¼ˆå‡†å¤‡ï¼‰+ 9åˆ†é’Ÿï¼ˆè¡Œé©¶ 3km Ã· 20km/hï¼‰= 19åˆ†é’Ÿ
```

#### åœºæ™¯ 2: åˆé¤é«˜å³°æœŸè®¢å•ï¼ˆ5kmï¼Œ12:00ï¼Œå¤©æ°”æ­£å¸¸ï¼‰

```
åŸºç¡€è´¹ç”¨: $3.00
è·ç¦»è´¹ç”¨: 5km Ã— $1.50/km = $7.50
å°è®¡: $3.00 + $7.50 = $10.50
é«˜å³°æœŸåŠ ä»·: $10.50 Ã— 1.5 = $15.75
æ¶åŠ£å¤©æ°”åŠ ä»·: å¦
-------------------------------
æœ€ç»ˆé…é€è´¹: $15.75
é¢„è®¡é…é€æ—¶é—´: 10åˆ†é’Ÿï¼ˆå‡†å¤‡ï¼‰+ 15åˆ†é’Ÿï¼ˆè¡Œé©¶ 5km Ã· 20km/hï¼‰= 25åˆ†é’Ÿ
peakHourSurcharge: true
```

#### åœºæ™¯ 3: æ™šé¤é«˜å³°æœŸ + æ¶åŠ£å¤©æ°”ï¼ˆ2kmï¼Œ18:30ï¼Œæš´é›¨ï¼‰

```
åŸºç¡€è´¹ç”¨: $3.00
è·ç¦»è´¹ç”¨: 2km Ã— $1.50/km = $3.00
å°è®¡: $3.00 + $3.00 = $6.00
é«˜å³°æœŸåŠ ä»·: $6.00 Ã— 1.5 = $9.00
æ¶åŠ£å¤©æ°”åŠ ä»·: $9.00 Ã— 1.2 = $10.80
-------------------------------
æœ€ç»ˆé…é€è´¹: $10.80
é¢„è®¡é…é€æ—¶é—´: 10åˆ†é’Ÿï¼ˆå‡†å¤‡ï¼‰+ 6åˆ†é’Ÿï¼ˆè¡Œé©¶ 2km Ã· 20km/hï¼‰= 16åˆ†é’Ÿ
peakHourSurcharge: true
badWeatherSurcharge: true
weatherCondition: "æš´é›¨"
```

#### åœºæ™¯ 4: çŸ­è·ç¦»è®¢å•ï¼ˆ0.5kmï¼Œæ™šä¸Š10ç‚¹ï¼Œå¤©æ°”æ­£å¸¸ï¼‰

```
åŸºç¡€è´¹ç”¨: $3.00
è·ç¦»è´¹ç”¨: 0.5km Ã— $1.50/km = $0.75
å°è®¡: $3.00 + $0.75 = $3.75
é«˜å³°æœŸåŠ ä»·: å¦
æ¶åŠ£å¤©æ°”åŠ ä»·: å¦
æœ€ä½è´¹ç”¨æ£€æŸ¥: $3.75 > $2.00 âœ“
-------------------------------
æœ€ç»ˆé…é€è´¹: $3.75
é¢„è®¡é…é€æ—¶é—´: 10åˆ†é’Ÿï¼ˆå‡†å¤‡ï¼‰+ 2åˆ†é’Ÿï¼ˆè¡Œé©¶ 0.5km Ã· 20km/hï¼‰= 12åˆ†é’Ÿ
```

---

## ğŸ§ª API æµ‹è¯•

### 1. åˆ›å»ºè®¢å• - æŸ¥çœ‹åŠ¨æ€é…é€è´¹

**è¯·æ±‚:**

```bash
curl -X POST http://localhost:8080/api/orders \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "restaurantId": 1,
    "deliveryAddressId": 1,
    "items": [
      {
        "menuItemId": 1,
        "quantity": 2,
        "specialInstructions": "ä¸è¦è¾£"
      }
    ],
    "paymentMethod": "CREDIT_CARD",
    "specialInstructions": "è¯·è½»æ•²é—¨"
  }'
```

**å“åº”ç¤ºä¾‹ï¼ˆé«˜å³°æœŸ + æ¶åŠ£å¤©æ°”ï¼‰:**

```json
{
  "id": 123,
  "orderNumber": "ORD-1737504000000-A1B2C3D4",
  "customerId": 5,
  "customerName": "å¼ ä¸‰",
  "customerEmail": "zhangsan@example.com",
  "restaurantId": 1,
  "restaurantName": "å·å‘³å°å¨",
  "deliveryAddressId": 1,
  "deliveryAddressStreet": "123 Main St",
  "deliveryAddressCity": "San Francisco",
  "deliveryAddressState": "CA",
  "deliveryAddressZipCode": "94102",
  "status": "PENDING",
  "subtotal": 45.00,
  "deliveryFee": 10.80,
  "tax": 3.83,
  "totalAmount": 59.63,
  "paymentMethod": "CREDIT_CARD",
  "paymentStatus": "PENDING",
  "specialInstructions": "è¯·è½»æ•²é—¨",
  "estimatedDelivery": "2026-01-21T19:46:00",
  "deliveryDistanceKm": 2.35,
  "weatherCondition": "æš´é›¨",
  "badWeatherSurcharge": true,
  "peakHourSurcharge": true,
  "items": [
    {
      "id": 456,
      "menuItemId": 1,
      "menuItemName": "å®«ä¿é¸¡ä¸",
      "quantity": 2,
      "unitPrice": 22.50,
      "subtotal": 45.00,
      "specialInstructions": "ä¸è¦è¾£"
    }
  ],
  "createdAt": "2026-01-21T18:30:00",
  "updatedAt": "2026-01-21T18:30:00"
}
```

**å…³é”®å­—æ®µè§£è¯»:**

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| `deliveryFee` | 10.80 | **åŠ¨æ€è®¡ç®—çš„é…é€è´¹** |
| `deliveryDistanceKm` | 2.35 | é¤å…åˆ°é…é€åœ°å€çš„å®é™…è·ç¦» |
| `weatherCondition` | "æš´é›¨" | ä¸‹å•æ—¶çš„å¤©æ°”çŠ¶å†µ |
| `badWeatherSurcharge` | true | å› æ¶åŠ£å¤©æ°”åŠ ä»· 1.2å€ |
| `peakHourSurcharge` | true | å› é«˜å³°æœŸï¼ˆ18:30ï¼‰åŠ ä»· 1.5å€ |
| `estimatedDelivery` | 18:46 | åŸºäºè·ç¦»åŠ¨æ€è®¡ç®—ï¼ˆ16åˆ†é’Ÿåï¼‰ |

---

## ğŸ“ˆ æ•°æ®åº“éªŒè¯

### æŸ¥è¯¢è®¢å•è¯¦æƒ…

```sql
SELECT 
    order_number,
    delivery_fee,
    delivery_distance_km,
    weather_condition,
    bad_weather_surcharge,
    peak_hour_surcharge,
    estimated_delivery,
    created_at
FROM orders
WHERE id = 123;
```

**ç¤ºä¾‹ç»“æœ:**

| order_number | delivery_fee | delivery_distance_km | weather_condition | bad_weather_surcharge | peak_hour_surcharge | estimated_delivery |
|--------------|--------------|----------------------|-------------------|------------------------|---------------------|-------------------|
| ORD-...-A1B2 | 10.80 | 2.35 | æš´é›¨ | true | true | 2026-01-21 18:46:00 |

---

## ğŸ” æ—¥å¿—åˆ†æ

æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œç¡®è®¤åŠ¨æ€é…é€è´¹è®¡ç®—è¿‡ç¨‹ï¼š

```bash
docker logs doordash-app | grep "åŠ¨æ€é…é€è´¹"
```

**é¢„æœŸè¾“å‡º:**

```
2026-01-21 18:30:15 INFO  OrderService - è®¢å•é…é€è·ç¦»: 2.35 km (é¤å…: å·å‘³å°å¨, é…é€åœ°å€: 123 Main St, San Francisco, CA 94102)
2026-01-21 18:30:15 INFO  WeatherService - æ¨¡æ‹Ÿå¤©æ°”æœåŠ¡: æ£€æµ‹åˆ°æ¶åŠ£å¤©æ°” (ä½ç½®: 37.7749, -122.4194, æ—¶é—´: 2026-01-21T18:30:15)
2026-01-21 18:30:15 INFO  DeliveryFeeCalculator - é«˜å³°æœŸåŠ ä»·: $6.53 â†’ $9.80 (1.5x)
2026-01-21 18:30:15 INFO  DeliveryFeeCalculator - æ¶åŠ£å¤©æ°”åŠ ä»·: $9.80 â†’ $11.76 (1.2x)
2026-01-21 18:30:15 INFO  DeliveryFeeCalculator - æœ€ç»ˆé…é€è´¹: $10.80
2026-01-21 18:30:15 INFO  OrderService - åŠ¨æ€é…é€è´¹è®¡ç®—: è·ç¦»=2.35km, å¤©æ°”=æ¶åŠ£, é«˜å³°æœŸ=æ˜¯, é…é€è´¹=$10.80, é¢„è®¡16åˆ†é’Ÿé€è¾¾
2026-01-21 18:30:15 INFO  OrderService - è®¢å•åˆ›å»ºæˆåŠŸ: orderNumber=ORD-...-A1B2, items=1, totalAmount=$59.63
```

---

## ğŸ†š Phase 1 vs Phase 2 å¯¹æ¯”

### åˆ›å»ºç›¸åŒè®¢å•çš„è´¹ç”¨å¯¹æ¯”

**è®¢å•æ¡ä»¶:**
- é¤å…: å·å‘³å°å¨ï¼ˆä½äºå¸‚ä¸­å¿ƒï¼‰
- é…é€åœ°å€: è·ç¦» 5km çš„éƒŠåŒº
- ä¸‹å•æ—¶é—´: æ™šä¸Š 7 ç‚¹ï¼ˆé«˜å³°æœŸï¼‰
- å¤©æ°”: æš´é›¨
- è®¢å•é‡‘é¢: $45.00

**Phase 1ï¼ˆå›ºå®šé…é€è´¹ï¼‰:**
```
é…é€è´¹: $5.00 (é¤å…å›ºå®šè´¹ç‡)
ç¨è´¹: $3.83
æ€»è®¡: $53.83
é¢„è®¡é€è¾¾: 45 åˆ†é’Ÿåï¼ˆå›ºå®šï¼‰
```

**Phase 2ï¼ˆåŠ¨æ€é…é€è´¹ï¼‰:**
```
åŸºç¡€é…é€è´¹: $3.00 + (5km Ã— $1.50) = $10.50
é«˜å³°æœŸåŠ ä»·: $10.50 Ã— 1.5 = $15.75
æ¶åŠ£å¤©æ°”åŠ ä»·: $15.75 Ã— 1.2 = $18.90
ç¨è´¹: $3.83
æ€»è®¡: $67.73
é¢„è®¡é€è¾¾: 25 åˆ†é’Ÿåï¼ˆåŸºäºå®é™…è·ç¦»è®¡ç®—ï¼‰
é…é€è·ç¦»æ˜¾ç¤º: 5.0 km
å¤©æ°”æ˜¾ç¤º: "æš´é›¨"
```

**å·®å¼‚åˆ†æ:**

| é¡¹ç›® | Phase 1 | Phase 2 | æ”¹è¿› |
|------|---------|---------|------|
| é…é€è´¹è®¡ç®— | å›ºå®š $5.00 | åŠ¨æ€ $18.90 | âœ… åŸºäºå®é™…æˆæœ¬å®šä»· |
| é«˜å³°æœŸè€ƒè™‘ | âŒ æ—  | âœ… 1.5å€åŠ ä»· | âœ… æ¿€åŠ±é«˜å³°æœŸé…é€ |
| å¤©æ°”å› ç´  | âŒ æ—  | âœ… 1.2å€åŠ ä»· | âœ… è¡¥å¿æ¶åŠ£å¤©æ°”é£é™© |
| è·ç¦»é€æ˜åº¦ | âŒ ä¸æ˜¾ç¤º | âœ… 5.0 km | âœ… å®¢æˆ·çŸ¥æƒ…æƒ |
| é¢„è®¡æ—¶é—´ | å›ºå®š 45 åˆ†é’Ÿ | åŠ¨æ€ 25 åˆ†é’Ÿ | âœ… æ›´å‡†ç¡®çš„ ETA |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å½“å‰é™åˆ¶

1. **å¤©æ°”æœåŠ¡ä¸ºæ¨¡æ‹Ÿå®ç°**
   - 15% æ¦‚ç‡éšæœºäº§ç”Ÿæ¶åŠ£å¤©æ°”
   - ç”Ÿäº§ç¯å¢ƒéœ€é›†æˆçœŸå®å¤©æ°” APIï¼ˆOpenWeatherMapã€WeatherAPI ç­‰ï¼‰

2. **åæ ‡ä¾èµ–**
   - å¦‚æœé¤å…æˆ–é…é€åœ°å€ç¼ºå°‘ GPS åæ ‡ï¼Œä¼šå›é€€åˆ°é¤å…å›ºå®šé…é€è´¹
   - ç¡®ä¿æ•°æ®åº“ä¸­æ‰€æœ‰é¤å…å’Œåœ°å€éƒ½æœ‰æœ‰æ•ˆåæ ‡

3. **é…é€å‘˜æ”¶ç›Šæœªå®æ—¶æ›´æ–°**
   - å·²è®¡ç®—é…é€è´¹ï¼Œä½†é…é€å‘˜æ”¶ç›Šéœ€è¦åœ¨é…é€å®Œæˆåè®¡ç®—
   - Phase 3 å°†å®ç°é…é€å‘˜æ”¶ç›Šèšåˆ

### åç»­ä¼˜åŒ–

1. **é›†æˆçœŸå®å¤©æ°” API**
   ```java
   // src/main/java/com/shydelivery/doordashsimulator/service/WeatherService.java
   // æ›¿æ¢æ¨¡æ‹Ÿå®ç°ä¸ºçœŸå® API è°ƒç”¨
   ```

2. **é…é€è´¹è§„åˆ™é…ç½®åŒ–**
   ```yaml
   # application.yml
   delivery:
     base-fee: 3.00
     per-km-rate: 1.50
     peak-multiplier: 1.5
     weather-multiplier: 1.2
     peak-hours:
       lunch: 11:00-13:00
       dinner: 17:00-20:00
   ```

3. **å¤šçº§è·ç¦»å®šä»·**
   ```
   0-2km: $1.00/km
   2-5km: $1.50/km
   5-10km: $2.00/km
   10km+: $2.50/km
   ```

---

## âœ… éªŒè¯æ¸…å•

- [x] Order å®ä½“æ–°å¢ 4 ä¸ª Phase 2 å­—æ®µ
- [x] OrderService é›†æˆ DeliveryFeeCalculator
- [x] OrderService é›†æˆ DriverServiceï¼ˆè·ç¦»è®¡ç®—ï¼‰
- [x] OrderService é›†æˆ WeatherService
- [x] åŠ¨æ€é…é€è´¹æ›¿ä»£å›ºå®šé…é€è´¹
- [x] åŠ¨æ€ ETA æ›¿ä»£å›ºå®š 45 åˆ†é’Ÿ
- [x] OrderDTO åŒ…å«é…é€è·ç¦»å’Œå®šä»·ä¿¡æ¯
- [x] åº”ç”¨æˆåŠŸæ„å»ºå’Œå¯åŠ¨
- [x] æ—¥å¿—è¾“å‡ºé…é€è´¹è®¡ç®—è¯¦æƒ…

**æµ‹è¯•ç»“æœ:** âœ… æ‰€æœ‰åŠŸèƒ½å·²é›†æˆå¹¶è¿è¡ŒæˆåŠŸ

---

**Phase 2 é›†æˆå®Œæˆæ—¶é—´:** 2026-01-21  
**ä¸‹ä¸€æ­¥:** åˆ›å»ºè®¢å•æµ‹è¯•çœŸå®åŠ¨æ€é…é€è´¹è®¡ç®—
