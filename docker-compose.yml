# ============================================
# Docker Compose 配置文件
# 用于本地开发和测试环境
# ============================================

services:
  # ----------------------------------------
  # PostgreSQL 数据库服务
  # ----------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: doordash-postgres
    
    # 环境变量配置
    environment:
      POSTGRES_DB: doordash_db          # 数据库名
      POSTGRES_USER: postgres            # 用户名
      POSTGRES_PASSWORD: postgres123     # 密码（生产环境使用secrets）
      PGDATA: /var/lib/postgresql/data/pgdata
    
    # 端口映射：宿主机端口:容器端口
    ports:
      - "5432:5432"
    
    # 数据持久化：将数据保存到本地，容器删除后数据不丢失
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    # 容器重启策略
    restart: unless-stopped
    
    # 使用自定义网络
    networks:
      - doordash-network

  # ----------------------------------------
  # Spring Boot 应用服务
  # ----------------------------------------
  app:
    build:
      context: .                         # Dockerfile所在目录
      dockerfile: Dockerfile
    
    container_name: doordash-app
    
    # 依赖关系：等待postgres启动后再启动应用
    depends_on:
      postgres:
        condition: service_healthy
    
    # 环境变量：覆盖application.yml中的配置
    environment:
      # 数据库连接配置
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/doordash_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres123
      
      # JPA配置
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      
      # 应用配置
      SERVER_PORT: 8080
      
      # JWT配置（建议使用环境变量而非配置文件）
      JWT_SECRET: dev-secret-key-change-in-production-min-256-bits
      JWT_EXPIRATION: 86400000
    
    # 端口映射
    ports:
      - "8080:8080"
    
    # 容器重启策略
    restart: unless-stopped
    
    # 使用自定义网络
    networks:
      - doordash-network
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ----------------------------------------
  # pgAdmin（可选）- PostgreSQL管理工具
  # ----------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: doordash-pgadmin
    
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@doordash.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    
    ports:
      - "5050:80"
    
    depends_on:
      - postgres
    
    networks:
      - doordash-network
    
    restart: unless-stopped

# ----------------------------------------
# 数据卷定义
# ----------------------------------------
volumes:
  postgres_data:
    driver: local

# ----------------------------------------
# 网络定义
# ----------------------------------------
networks:
  doordash-network:
    driver: bridge

# ============================================
# 使用说明:
#
# 启动所有服务:
#   docker-compose up -d
#
# 查看日志:
#   docker-compose logs -f
#   docker-compose logs -f app
#
# 停止所有服务:
#   docker-compose down
#
# 停止并删除数据:
#   docker-compose down -v
#
# 重新构建应用:
#   docker-compose up -d --build
#
# 访问地址:
#   应用: http://localhost:8080/api
#   Swagger: http://localhost:8080/api/swagger-ui.html
#   pgAdmin: http://localhost:5050
# ============================================
