# ============================================
# Docker Compose Configuration File
# For local development and testing environment
# ============================================

services:
  # ----------------------------------------
  # PostgreSQL Database Service
  # ----------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: doordash-postgres
    
    # Environment variable configuration
    environment:
      POSTGRES_DB: doordash_db          # Database name
      POSTGRES_USER: postgres            # Username
      POSTGRES_PASSWORD: postgres123     # Password (use secrets in production)
      PGDATA: /var/lib/postgresql/data/pgdata
    
    # Port mapping: host_port:container_port
    ports:
      - "5432:5432"
    
    # Data persistence: save data locally, data persists after container deletion
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    # Container restart policy
    restart: unless-stopped
    
    # Use custom network
    networks:
      - doordash-network

  # ----------------------------------------
  # Spring Boot Application Service
  # ----------------------------------------
  app:
    build:
      context: .                         # Dockerfile location
      dockerfile: Dockerfile
    
    container_name: doordash-app
    
    # Dependency: wait for postgres to start before starting the app
    depends_on:
      postgres:
        condition: service_healthy
    
    # Environment variables: override configuration in application.yml
    environment:
      # Database connection configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/doordash_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres123
      
      # JPA configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      
      # Application configuration
      SERVER_PORT: 8080
      
      # JWT configuration (recommended to use environment variables instead of config files)
      JWT_SECRET: dev-secret-key-change-in-production-min-256-bits
      JWT_EXPIRATION: 86400000
    
    # Port mapping
    ports:
      - "8080:8080"
    
    # Container restart policy
    restart: unless-stopped
    
    # Use custom network
    networks:
      - doordash-network
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ----------------------------------------
  # pgAdmin (Optional) - PostgreSQL Management Tool
  # ----------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: doordash-pgadmin
    
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@doordash.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    
    ports:
      - "5050:80"
    
    depends_on:
      - postgres
    
    networks:
      - doordash-network
    
    restart: unless-stopped

# ----------------------------------------
# Volume Definitions
# ----------------------------------------
volumes:
  postgres_data:
    driver: local

# ----------------------------------------
# Network Definitions
# ----------------------------------------
networks:
  doordash-network:
    driver: bridge

# ============================================
# Usage Instructions:
#
# Start all services:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f
#   docker-compose logs -f app
#
# Stop all services:
#   docker-compose down
#
# Stop and remove data:
#   docker-compose down -v
#
# Rebuild application:
#   docker-compose up -d --build
#
# Access URLs:
#   Application: http://localhost:8080/api
#   Swagger: http://localhost:8080/api/swagger-ui.html
#   pgAdmin: http://localhost:5050
# ============================================
